# data.azurerm_resource_group.azure_resource_group_image_gallery:
data "azurerm_resource_group" "azure_resource_group_image_gallery" {
    id         = "/subscriptions/18573a3d-bbfc-45f7-9912-cfa159ecd0f5/resourceGroups/rg-mvd-core-ch-001"
    location   = "switzerlandnorth"
    managed_by = [90mnull[0m[0m
    name       = "rg-mvd-core-ch-001"
    tags       = {}
}

# data.azurerm_resource_group.azure_resource_group_main:
data "azurerm_resource_group" "azure_resource_group_main" {
    id         = "/subscriptions/18573a3d-bbfc-45f7-9912-cfa159ecd0f5/resourceGroups/rg-mvd-m020-ch-001"
    location   = "switzerlandnorth"
    managed_by = [90mnull[0m[0m
    name       = "rg-mvd-m020-ch-001"
    tags       = {
        "Cost_Center_tag"  = "99999"
        "Function"         = "Managed Virtual Desktop"
        "TerraformVersion" = ">=1.5"
        "environment_tag"  = "P"
        "source"           = "terraform"
    }
}

# data.azurerm_shared_image_gallery.azure_image_gallery_main:
data "azurerm_shared_image_gallery" "azure_image_gallery_main" {
    description         = "Shared Image Gallery for Windows images"
    id                  = "/subscriptions/18573a3d-bbfc-45f7-9912-cfa159ecd0f5/resourceGroups/rg-mvd-core-ch-001/providers/Microsoft.Compute/galleries/gal_mvd_sta_ch_02"
    image_names         = [
        "b20_S_HSD_MCS__oe4ww",
        "m01_T_VDI_MCS__xsk78",
        "sta-svr-19-23h2-std-cor-gen-001",
        "sta-svr-19-23h2-std-cor-spe-001",
        "sta-svr-22-23h2-std-cor-gen-001",
        "sta-svr-22-23h2-std-cor-spe-001",
        "sta-win-11-23h2-avd-cor-ctx-001",
        "sta-win-11-23h2-avd-ctx-gen-001",
        "sta-win-11-23h2-pro-ctx-gen-001",
        "sta-win-11-23h2-pro-ctx-spe-001",
    ]
    location            = "switzerlandnorth"
    name                = "gal_mvd_sta_ch_02"
    resource_group_name = "rg-mvd-core-ch-001"
    tags                = {
        "CostCenter"   = "mcore"
        "CreationDate" = "2025-05-03"
        "Environment"  = "dev"
        "ManagedBy"    = "Terraform"
        "Owner"        = "SIT Team"
        "Project"      = "Azure Image Gallery"
        "Purpose"      = "Shared Windows Images"
    }
    unique_name         = "18573a3d-bbfc-45f7-9912-cfa159ecd0f5-GAL_MVD_STA_CH_02"
}

# data.azurerm_subnet.azure_subnet_main:
data "azurerm_subnet" "azure_subnet_main" {
    address_prefix                                = "10.20.0.0/24"
    address_prefixes                              = [
        "10.20.0.0/24",
    ]
    default_outbound_access_enabled               = true
    id                                            = "/subscriptions/18573a3d-bbfc-45f7-9912-cfa159ecd0f5/resourceGroups/rg-mvd-m020-ch-001/providers/Microsoft.Network/virtualNetworks/vnet-m020-ch-001/subnets/snet-m020-ch-001"
    name                                          = "snet-m020-ch-001"
    network_security_group_id                     = "/subscriptions/18573a3d-bbfc-45f7-9912-cfa159ecd0f5/resourceGroups/rg-mvd-m020-ch-001/providers/Microsoft.Network/networkSecurityGroups/nsg-m020-ch-001"
    private_endpoint_network_policies             = "Disabled"
    private_link_service_network_policies_enabled = true
    resource_group_name                           = "rg-mvd-m020-ch-001"
    route_table_id                                = [90mnull[0m[0m
    service_endpoints                             = []
    virtual_network_name                          = "vnet-m020-ch-001"
}

# data.azurerm_virtual_machine.azure_virtual_machine_profile:
data "azurerm_virtual_machine" "azure_virtual_machine_profile" {
    id                   = "/subscriptions/18573a3d-bbfc-45f7-9912-cfa159ecd0f5/resourceGroups/rg-mvd-m020-ch-001/providers/Microsoft.Compute/virtualMachines/mvd020050001"
    identity             = []
    location             = "switzerlandnorth"
    name                 = "mvd020050001"
    power_state          = "deallocated"
    private_ip_address   = "10.20.0.5"
    private_ip_addresses = [
        "10.20.0.5",
    ]
    public_ip_address    = [90mnull[0m[0m
    public_ip_addresses  = []
    resource_group_name  = "rg-mvd-m020-ch-001"
}

# data.citrix_zone.citrix_daas_zone_main:
data "citrix_zone" "citrix_daas_zone_main" {
    id   = "b456e68d-c538-4e34-8c51-cc9c711e01a5"
    name = "mvd-020-p-azure"
}

# data.gitlab_project.gitlab_project_main:
data "gitlab_project" "gitlab_project_main" {
    allow_pipeline_trigger_approve_deployment   = false
    analytics_access_level                      = "enabled"
    archived                                    = false
    auto_cancel_pending_pipelines               = "enabled"
    auto_devops_deploy_strategy                 = "continuous"
    auto_devops_enabled                         = false
    autoclose_referenced_issues                 = false
    build_git_strategy                          = "fetch"
    build_timeout                               = 3600
    builds_access_level                         = "enabled"
    ci_config_path                              = [90mnull[0m[0m
    ci_default_git_depth                        = 20
    ci_delete_pipelines_in_seconds              = 0
    ci_id_token_sub_claim_components            = [
        "project_path",
        "ref_type",
        "ref",
    ]
    ci_pipeline_variables_minimum_override_role = "developer"
    ci_restrict_pipeline_cancellation_role      = [90mnull[0m[0m
    ci_separated_caches                         = true
    container_expiration_policy                 = [
        {
            cadence           = "1d"
            enabled           = false
            keep_n            = 10
            name_regex_delete = ".*"
            name_regex_keep   = [90mnull[0m[0m
            next_run_at       = "2025-07-23T04:13:05Z"
            older_than        = "90d"
        },
    ]
    container_registry_access_level             = "enabled"
    default_branch                              = "main"
    description                                 = [90mnull[0m[0m
    emails_enabled                              = true
    empty_repo                                  = false
    environments_access_level                   = "enabled"
    external_authorization_classification_label = [90mnull[0m[0m
    feature_flags_access_level                  = "enabled"
    forking_access_level                        = "enabled"
    http_url_to_repo                            = "https://gitlab.com/sintes/do/mvd-azu/vm-deployment.git"
    id                                          = "71817446"
    import_url                                  = [90mnull[0m[0m
    infrastructure_access_level                 = "enabled"
    issues_access_level                         = "enabled"
    issues_enabled                              = true
    keep_latest_artifact                        = true
    merge_commit_template                       = [90mnull[0m[0m
    merge_pipelines_enabled                     = false
    merge_requests_access_level                 = "enabled"
    merge_requests_enabled                      = true
    merge_trains_enabled                        = false
    model_experiments_access_level              = "enabled"
    model_registry_access_level                 = "enabled"
    monitor_access_level                        = "enabled"
    name                                        = "vm-deployment"
    namespace_id                                = 111289134
    path                                        = "vm-deployment"
    path_with_namespace                         = "sintes/do/mvd-azu/vm-deployment"
    pipelines_enabled                           = true
    prevent_merge_without_jira_issue            = false
    public_builds                               = true
    push_rules                                  = []
    releases_access_level                       = "enabled"
    remove_source_branch_after_merge            = true
    repository_access_level                     = "enabled"
    repository_storage                          = [90mnull[0m[0m
    request_access_enabled                      = true
    requirements_access_level                   = "enabled"
    resolve_outdated_diff_discussions           = false
    restrict_user_defined_variables             = false
    runners_token                               = (sensitive value)
    security_and_compliance_access_level        = "private"
    shared_with_groups                          = []
    snippets_access_level                       = "enabled"
    snippets_enabled                            = true
    squash_commit_template                      = [90mnull[0m[0m
    ssh_url_to_repo                             = "git@gitlab.com:sintes/do/mvd-azu/vm-deployment.git"
    suggestion_commit_message                   = [90mnull[0m[0m
    topics                                      = [
        "managed-by-soos",
    ]
    visibility_level                            = "private"
    web_url                                     = "https://gitlab.com/sintes/do/mvd-azu/vm-deployment"
    wiki_access_level                           = "enabled"
    wiki_enabled                                = true
}

# data.gitlab_project_variable.gitlab_variable_windows_password:
data "gitlab_project_variable" "gitlab_variable_windows_password" {
    description       = [90mnull[0m[0m
    environment_scope = "*"
    id                = "71817446:windows_admin_password_020:*"
    key               = "windows_admin_password_020"
    masked            = true
    project           = "71817446"
    protected         = true
    raw               = false
    value             = "FqAnA2Dm~/54hn1hGFK:8tIO"
    variable_type     = "env_var"
}

# citrix_service_account.sc_for_machine_id_domain:
resource "citrix_service_account" "sc_for_machine_id_domain" {
    account_id                   = "m020\\azureuser"
    account_secret               = (sensitive value)
    account_secret_format        = "PlainText"
    description                  = [90mnull[0m[0m
    display_name                 = "az-ch-svc-m020-001"
    id                           = "5021dfad-f1f8-4fef-b468-db97f13f8a9b"
    identity_provider_identifier = "m020.abxcloud.ch"
    identity_provider_type       = "ActiveDirectory"
    scopes                       = []
}


# module.citrix_daas_application_folder.citrix_admin_folder.main:
resource "citrix_admin_folder" "main" {
    id                       = "12"
    name                     = "M020"
    path                     = "M020"
    total_application_groups = 0
    total_applications       = 0
    total_delivery_groups    = 1
    total_machine_catalogs   = 1
    type                     = [
        "ContainsApplicationGroups",
        "ContainsApplications",
        "ContainsDeliveryGroups",
        "ContainsMachineCatalogs",
    ]
}


# module.citrix_daas_hypervisor_azure.citrix_azure_hypervisor.hypervisor:
resource "citrix_azure_hypervisor" "hypervisor" {
    active_directory_id                        = "bfb830fa-7890-4254-80ee-46b0fc2add3b"
    application_id                             = "6f93f7c6-b851-4461-ae42-b5e72dcc9d6d"
    application_secret                         = (sensitive value)
    authentication_mode                        = "AppClientSecret"
    enable_azure_ad_device_management          = false
    id                                         = "6636b4f4-611e-47d1-a9e7-6a7d4c6db6fe"
    name                                       = "az-ch-hyp-m020-001"
    proxy_hypervisor_traffic_through_connector = false
    scopes                                     = []
    subscription_id                            = "18573a3d-bbfc-45f7-9912-cfa159ecd0f5"
    zone                                       = "b456e68d-c538-4e34-8c51-cc9c711e01a5"
}

# module.citrix_daas_hypervisor_azure.citrix_azure_hypervisor_resource_pool.resource_pool:
resource "citrix_azure_hypervisor_resource_pool" "resource_pool" {
    hypervisor                     = "6636b4f4-611e-47d1-a9e7-6a7d4c6db6fe"
    id                             = "fb3f6b76-2639-49b3-8bd2-adbd85378ebb"
    name                           = "vnet-020-ch-001"
    region                         = "Switzerland North"
    subnets                        = [
        "snet-m020-ch-001",
    ]
    virtual_network                = "vnet-m020-ch-001"
    virtual_network_resource_group = "rg-mvd-m020-ch-001"
    vm_tagging                     = true
}

# module.citrix_daas_hypervisor_azure.null_resource.wait_after_hypervisor:
resource "null_resource" "wait_after_hypervisor" {
    id = "5438806683212716639"
}


# module.citrix_delivery_group_hsd_test[0].citrix_delivery_group.hsd:
resource "citrix_delivery_group" "hsd" {
    associated_machine_catalogs = [
        {
            machine_catalog = "8af10867-5d22-4833-950e-c9ac4bedb9cf"
            machine_count   = 1
        },
    ]
    autoscale_settings          = {
        autoscale_enabled                                     = true
        disconnect_off_peak_idle_session_after_seconds        = 300
        disconnect_peak_idle_session_after_seconds            = 300
        log_off_off_peak_disconnected_session_after_seconds   = 60
        log_off_peak_disconnected_session_after_seconds       = 60
        log_off_reminder_enabled                              = false
        log_off_reminder_message                              = ""
        log_off_reminder_title                                = ""
        log_off_warning_message                               = ""
        log_off_warning_title                                 = ""
        off_peak_buffer_size_percent                          = 0
        off_peak_disconnect_action                            = "Nothing"
        off_peak_disconnect_timeout_minutes                   = 0
        off_peak_extended_disconnect_action                   = "Nothing"
        off_peak_extended_disconnect_timeout_minutes          = 0
        off_peak_limit_seconds_to_force_log_off_user          = 0
        off_peak_log_off_action                               = "Nothing"
        off_peak_log_off_reminder_interval                    = 0
        off_peak_log_off_timeout_minutes                      = 0
        peak_autoscale_assigned_power_on_idle_action          = "Nothing"
        peak_autoscale_assigned_power_on_idle_timeout_minutes = 0
        peak_buffer_size_percent                              = 0
        peak_disconnect_action                                = "Nothing"
        peak_disconnect_timeout_minutes                       = 0
        peak_extended_disconnect_action                       = "Nothing"
        peak_extended_disconnect_timeout_minutes              = 0
        peak_limit_seconds_to_force_log_off_user              = 0
        peak_log_off_action                                   = "Nothing"
        peak_log_off_reminder_interval                        = 0
        peak_log_off_timeout_minutes                          = 0
        power_off_delay_minutes                               = 0
        power_time_schemes                                    = [
            {
                days_of_week          = [
                    "Friday",
                    "Monday",
                    "Saturday",
                    "Sunday",
                    "Thursday",
                    "Tuesday",
                    "Wednesday",
                ]
                display_name          = "Development-Kostenoptimiert-24x7"
                peak_time_ranges      = []
                pool_using_percentage = false
            },
        ]
    }
    built_in_scopes             = [
        "00000000-0000-0000-0000-000000000000",
    ]
    color_depth                 = "TwentyFourBit"
    default_desktop_icon        = "-1"
    delivery_group_folder_path  = "M020"
    description                 = "Durch terraform für Kunden SIT-Mandant-m020 erstellt - HSD Desktop Publishing (Test)"
    desktops                    = [
        {
            description             = "KEYWORDS:Mandatory"
            enable_session_roaming  = false
            enabled                 = true
            id                      = "d8f16795-e598-4c94-bc00-dd7baa5f600f"
            published_name          = "020-HSD-Desktop-Test"
            restricted_access_users = {
                allow_list = [
                    "m020\\GG_RG-NS-ICA",
                ]
                block_list = []
            }
        },
    ]
    enabled                     = true
    force_delete                = true
    id                          = "426054e8-662d-4480-b907-96bb033443a2"
    in_maintenance_mode         = false
    inherited_scopes            = []
    load_balancing_type         = "Horizontal"
    minimum_functional_level    = "L7_34"
    name                        = "020-T-HSD-MCS-NON-ADJ-AZU-SIT-001"
    reboot_schedules            = [
        {
            description                  = "Nightly HSD Reboot"
            frequency                    = "Daily"
            frequency_factor             = 1
            ignore_maintenance_mode      = false
            name                         = "020-T-HSD-MCS-NON-ADJ-AZU-SIT-001-Reboot"
            natural_reboot_schedule      = false
            reboot_duration_minutes      = 30
            reboot_notification_to_users = {
                notification_duration_minutes       = 15
                notification_message                = "HSD Desktop will restart in 15 minutes"
                notification_repeat_every_5_minutes = true
                notification_title                  = "System Maintenance"
            }
            reboot_schedule_enabled      = true
            start_date                   = "2025-09-28"
            start_time                   = "22:00"
        },
    ]
    scopes                      = []
    secure_ica_required         = false
    session_support             = "MultiSession"
    sharing_kind                = "Shared"
    total_machines              = 1
}


# module.citrix_image_hsd.citrix_image_definition.hsd:
resource "citrix_image_definition" "hsd" {
    azure_image_definition   = {
        image_gallery_name = "gal_mvd_sta_ch_02"
        resource_group     = "rg-mvd-core-ch-001"
        use_image_gallery  = true
    }
    description              = "Windows Server 2022 HSD Multi Session Image für Mandant 020"
    hypervisor               = "6636b4f4-611e-47d1-a9e7-6a7d4c6db6fe"
    hypervisor_resource_pool = "fb3f6b76-2639-49b3-8bd2-adbd85378ebb"
    id                       = "1917deaa-8685-44a0-b923-79758315ceb9"
    latest_version           = 1
    name                     = "020-S-HSD-MCS-NON-ADJ-AZU-SIT-001"
    os_type                  = "Windows"
    session_support          = "MultiSession"
}

# module.citrix_image_hsd.citrix_image_version.hsd_multi["hsd_stable"]:
resource "citrix_image_version" "hsd_multi" {
    azure_image_specs        = {
        gallery_image    = {
            definition = "sta-svr-22-23h2-std-cor-spe-001"
            gallery    = "gal_mvd_sta_ch_02"
            version    = "2025.0922.0706"
        }
        machine_profile  = {
            machine_profile_resource_group = "rg-mvd-m020-ch-001"
            machine_profile_vm_name        = "mvd020050001"
        }
        resource_group   = "rg-mvd-core-ch-001"
        service_offering = "Standard_D2s_v3"
        storage_type     = "Premium_LRS"
    }
    description              = "Stable HSD version for production workloads"
    hypervisor               = "6636b4f4-611e-47d1-a9e7-6a7d4c6db6fe"
    hypervisor_resource_pool = "fb3f6b76-2639-49b3-8bd2-adbd85378ebb"
    id                       = "a5b7a0ff-3b41-4f42-9a34-92e7f585e1ac"
    image_definition         = "1917deaa-8685-44a0-b923-79758315ceb9"
    os_type                  = "Windows"
    session_support          = "MultiSession"
    version_number           = 1
}


# module.citrix_machine_catalog_hsd_test[0].citrix_machine_catalog.hsd:
resource "citrix_machine_catalog" "hsd" {
    allocation_type             = "Random"
    built_in_scopes             = [
        "00000000-0000-0000-0000-000000000000",
    ]
    delete_machine_accounts     = "Delete"
    delete_virtual_machines     = true
    description                 = "Durch terraform für Kunden SIT-Mandant-m020 erstellt (Test Environment)"
    id                          = "8af10867-5d22-4833-950e-c9ac4bedb9cf"
    inherited_scopes            = []
    machine_catalog_folder_path = "M020"
    minimum_functional_level    = "L7_34"
    name                        = "020-T-HSD-MCS-NON-ADJ-AZU-SIT-001"
    persist_user_changes        = "Discard"
    provisioning_scheme         = {
        azure_machine_config           = {
            image_update_reboot_options = {
                reboot_duration         = 60
                warning_duration        = 10
                warning_message         = "🔄 System-Update 🔄 läuft! Neustart in ⏱️ %m% Minuten.  Speichere deine Arbeit! 💾 Claude ⏱ & Dima 😎 Support 😊"
                warning_repeat_interval = 5
            }
            machine_profile             = {
                machine_profile_resource_group = "rg-mvd-m020-ch-001"
                machine_profile_vm_name        = "mvd020050001"
            }
            master_image_note           = ""
            prepared_image              = {
                image_definition = "1917deaa-8685-44a0-b923-79758315ceb9"
                image_version    = "a5b7a0ff-3b41-4f42-9a34-92e7f585e1ac"
            }
            service_offering            = "Standard_DC2ds_v3"
            storage_type                = "Azure_Ephemeral_OS_Disk"
            use_managed_disks           = true
            vda_resource_group          = "rg-mvd-m020-ch-001"
        }
        hypervisor                     = "6636b4f4-611e-47d1-a9e7-6a7d4c6db6fe"
        hypervisor_resource_pool       = "fb3f6b76-2639-49b3-8bd2-adbd85378ebb"
        identity_type                  = "ActiveDirectory"
        machine_account_creation_rules = {
            naming_scheme      = "mvd020051###"
            naming_scheme_type = "Numeric"
        }
        machine_domain_identity        = (sensitive value)
        number_of_total_machines       = 1
    }
    provisioning_type           = "MCS"
    scopes                      = []
    session_support             = "MultiSession"
    zone                        = "b456e68d-c538-4e34-8c51-cc9c711e01a5"
}


# module.citrix_published_applications["notepad"].citrix_application.published_application[0]:
resource "citrix_application" "published_application" {
    application_category_path      = ""
    application_folder_path        = "M020"
    application_groups             = []
    browser_name                   = "notepad-pa-app"
    cpu_priority_level             = "Normal"
    delivery_groups                = [
        "426054e8-662d-4480-b907-96bb033443a2",
    ]
    description                    = "Windows Notepad Text Editor"
    enabled                        = true
    home_zone_mode                 = "User"
    icon                           = "0"
    id                             = "c0c0045d-b4cd-448e-9575-19e87f25371c"
    installed_app_properties       = {
        command_line_executable = "C:\\Windows\\System32\\notepad.exe"
        working_directory       = "C:\\"
    }
    limit_to_one_instance_per_user = false
    max_total_instances            = 0
    name                           = "notepad-pa-app"
    published_name                 = "Notepad"
    shortcut_added_to_desktop      = false
    shortcut_added_to_start_menu   = false
    visible                        = true
}
