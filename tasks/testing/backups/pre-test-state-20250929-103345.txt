# data.azurerm_resource_group.azure_resource_group_image_gallery:
data "azurerm_resource_group" "azure_resource_group_image_gallery" {
    id         = "/subscriptions/18573a3d-bbfc-45f7-9912-cfa159ecd0f5/resourceGroups/rg-mvd-core-ch-001"
    location   = "switzerlandnorth"
    managed_by = [90mnull[0m[0m
    name       = "rg-mvd-core-ch-001"
    tags       = {}
}

# data.azurerm_resource_group.azure_resource_group_main:
data "azurerm_resource_group" "azure_resource_group_main" {
    id         = "/subscriptions/18573a3d-bbfc-45f7-9912-cfa159ecd0f5/resourceGroups/rg-mvd-m020-ch-001"
    location   = "switzerlandnorth"
    managed_by = [90mnull[0m[0m
    name       = "rg-mvd-m020-ch-001"
    tags       = {
        "Cost_Center_tag"  = "99999"
        "Function"         = "Managed Virtual Desktop"
        "TerraformVersion" = ">=1.5"
        "environment_tag"  = "P"
        "source"           = "terraform"
    }
}

# data.azurerm_shared_image_gallery.azure_image_gallery_main:
data "azurerm_shared_image_gallery" "azure_image_gallery_main" {
    description         = "Shared Image Gallery for Windows images"
    id                  = "/subscriptions/18573a3d-bbfc-45f7-9912-cfa159ecd0f5/resourceGroups/rg-mvd-core-ch-001/providers/Microsoft.Compute/galleries/gal_mvd_sta_ch_02"
    image_names         = [
        "m01_T_VDI_MCS__xsk78",
        "r20_S_HSD_MCS__50643",
        "sta-svr-19-23h2-std-cor-gen-001",
        "sta-svr-19-23h2-std-cor-spe-001",
        "sta-svr-22-23h2-std-cor-gen-001",
        "sta-svr-22-23h2-std-cor-spe-001",
        "sta-win-11-23h2-avd-cor-ctx-001",
        "sta-win-11-23h2-avd-ctx-gen-001",
        "sta-win-11-23h2-pro-ctx-gen-001",
        "sta-win-11-23h2-pro-ctx-spe-001",
    ]
    location            = "switzerlandnorth"
    name                = "gal_mvd_sta_ch_02"
    resource_group_name = "rg-mvd-core-ch-001"
    tags                = {
        "CostCenter"   = "mcore"
        "CreationDate" = "2025-05-03"
        "Environment"  = "dev"
        "ManagedBy"    = "Terraform"
        "Owner"        = "SIT Team"
        "Project"      = "Azure Image Gallery"
        "Purpose"      = "Shared Windows Images"
    }
    unique_name         = "18573a3d-bbfc-45f7-9912-cfa159ecd0f5-GAL_MVD_STA_CH_02"
}

# data.azurerm_subnet.azure_subnet_main:
data "azurerm_subnet" "azure_subnet_main" {
    address_prefix                                = "10.20.0.0/24"
    address_prefixes                              = [
        "10.20.0.0/24",
    ]
    default_outbound_access_enabled               = true
    id                                            = "/subscriptions/18573a3d-bbfc-45f7-9912-cfa159ecd0f5/resourceGroups/rg-mvd-m020-ch-001/providers/Microsoft.Network/virtualNetworks/vnet-m020-ch-001/subnets/snet-m020-ch-001"
    name                                          = "snet-m020-ch-001"
    network_security_group_id                     = "/subscriptions/18573a3d-bbfc-45f7-9912-cfa159ecd0f5/resourceGroups/rg-mvd-m020-ch-001/providers/Microsoft.Network/networkSecurityGroups/nsg-m020-ch-001"
    private_endpoint_network_policies             = "Disabled"
    private_link_service_network_policies_enabled = true
    resource_group_name                           = "rg-mvd-m020-ch-001"
    route_table_id                                = [90mnull[0m[0m
    service_endpoints                             = []
    virtual_network_name                          = "vnet-m020-ch-001"
}

# data.azurerm_virtual_machine.azure_virtual_machine_profile:
data "azurerm_virtual_machine" "azure_virtual_machine_profile" {
    id                   = "/subscriptions/18573a3d-bbfc-45f7-9912-cfa159ecd0f5/resourceGroups/rg-mvd-m020-ch-001/providers/Microsoft.Compute/virtualMachines/mvd020050001"
    identity             = []
    location             = "switzerlandnorth"
    name                 = "mvd020050001"
    power_state          = "deallocated"
    private_ip_address   = "10.20.0.5"
    private_ip_addresses = [
        "10.20.0.5",
    ]
    public_ip_address    = [90mnull[0m[0m
    public_ip_addresses  = []
    resource_group_name  = "rg-mvd-m020-ch-001"
}

# data.citrix_zone.citrix_daas_zone_main:
data "citrix_zone" "citrix_daas_zone_main" {
    id   = "b456e68d-c538-4e34-8c51-cc9c711e01a5"
    name = "mvd-020-p-azure"
}

# data.gitlab_project.gitlab_project_main:
data "gitlab_project" "gitlab_project_main" {
    allow_pipeline_trigger_approve_deployment   = false
    analytics_access_level                      = "enabled"
    archived                                    = false
    auto_cancel_pending_pipelines               = "enabled"
    auto_devops_deploy_strategy                 = "continuous"
    auto_devops_enabled                         = false
    autoclose_referenced_issues                 = false
    build_git_strategy                          = "fetch"
    build_timeout                               = 3600
    builds_access_level                         = "enabled"
    ci_config_path                              = [90mnull[0m[0m
    ci_default_git_depth                        = 20
    ci_delete_pipelines_in_seconds              = 0
    ci_id_token_sub_claim_components            = [
        "project_path",
        "ref_type",
        "ref",
    ]
    ci_pipeline_variables_minimum_override_role = "developer"
    ci_restrict_pipeline_cancellation_role      = [90mnull[0m[0m
    ci_separated_caches                         = true
    container_expiration_policy                 = [
        {
            cadence           = "1d"
            enabled           = false
            keep_n            = 10
            name_regex_delete = ".*"
            name_regex_keep   = [90mnull[0m[0m
            next_run_at       = "2025-07-23T04:13:05Z"
            older_than        = "90d"
        },
    ]
    container_registry_access_level             = "enabled"
    default_branch                              = "main"
    description                                 = [90mnull[0m[0m
    emails_enabled                              = true
    empty_repo                                  = false
    environments_access_level                   = "enabled"
    external_authorization_classification_label = [90mnull[0m[0m
    feature_flags_access_level                  = "enabled"
    forking_access_level                        = "enabled"
    http_url_to_repo                            = "https://gitlab.com/sintes/do/mvd-azu/vm-deployment.git"
    id                                          = "71817446"
    import_url                                  = [90mnull[0m[0m
    infrastructure_access_level                 = "enabled"
    issues_access_level                         = "enabled"
    issues_enabled                              = true
    keep_latest_artifact                        = true
    merge_commit_template                       = [90mnull[0m[0m
    merge_pipelines_enabled                     = false
    merge_requests_access_level                 = "enabled"
    merge_requests_enabled                      = true
    merge_trains_enabled                        = false
    model_experiments_access_level              = "enabled"
    model_registry_access_level                 = "enabled"
    monitor_access_level                        = "enabled"
    name                                        = "vm-deployment"
    namespace_id                                = 111289134
    path                                        = "vm-deployment"
    path_with_namespace                         = "sintes/do/mvd-azu/vm-deployment"
    pipelines_enabled                           = true
    prevent_merge_without_jira_issue            = false
    public_builds                               = true
    push_rules                                  = []
    releases_access_level                       = "enabled"
    remove_source_branch_after_merge            = true
    repository_access_level                     = "enabled"
    repository_storage                          = [90mnull[0m[0m
    request_access_enabled                      = true
    requirements_access_level                   = "enabled"
    resolve_outdated_diff_discussions           = false
    restrict_user_defined_variables             = false
    runners_token                               = (sensitive value)
    security_and_compliance_access_level        = "private"
    shared_with_groups                          = []
    snippets_access_level                       = "enabled"
    snippets_enabled                            = true
    squash_commit_template                      = [90mnull[0m[0m
    ssh_url_to_repo                             = "git@gitlab.com:sintes/do/mvd-azu/vm-deployment.git"
    suggestion_commit_message                   = [90mnull[0m[0m
    topics                                      = [
        "managed-by-soos",
    ]
    visibility_level                            = "private"
    web_url                                     = "https://gitlab.com/sintes/do/mvd-azu/vm-deployment"
    wiki_access_level                           = "enabled"
    wiki_enabled                                = true
}

# data.gitlab_project_variable.gitlab_variable_windows_password:
data "gitlab_project_variable" "gitlab_variable_windows_password" {
    description       = [90mnull[0m[0m
    environment_scope = "*"
    id                = "71817446:windows_admin_password_020:*"
    key               = "windows_admin_password_020"
    masked            = true
    project           = "71817446"
    protected         = true
    raw               = false
    value             = "FqAnA2Dm~/54hn1hGFK:8tIO"
    variable_type     = "env_var"
}

# citrix_service_account.sc_for_machine_id_domain:
resource "citrix_service_account" "sc_for_machine_id_domain" {
    account_id                   = "m020\\azureuser"
    account_secret               = (sensitive value)
    account_secret_format        = "PlainText"
    description                  = [90mnull[0m[0m
    display_name                 = "az-ch-svc-m020-001"
    id                           = "77995520-8fc1-42c1-9af6-c4463581d135"
    identity_provider_identifier = "m020.abxcloud.ch"
    identity_provider_type       = "ActiveDirectory"
    scopes                       = []
}


# module.citrix_daas_application_folder.citrix_admin_folder.main:
resource "citrix_admin_folder" "main" {
    id                       = "14"
    name                     = "M020"
    path                     = "M020"
    total_application_groups = 0
    total_applications       = 1
    total_delivery_groups    = 1
    total_machine_catalogs   = 1
    type                     = [
        "ContainsApplicationGroups",
        "ContainsApplications",
        "ContainsDeliveryGroups",
        "ContainsMachineCatalogs",
    ]
}


# module.citrix_daas_hypervisor_azure.citrix_azure_hypervisor.hypervisor:
resource "citrix_azure_hypervisor" "hypervisor" {
    active_directory_id                        = "bfb830fa-7890-4254-80ee-46b0fc2add3b"
    application_id                             = "6f93f7c6-b851-4461-ae42-b5e72dcc9d6d"
    application_secret                         = (sensitive value)
    authentication_mode                        = "AppClientSecret"
    enable_azure_ad_device_management          = false
    id                                         = "5ff86c7a-4c3a-4c79-9f0d-ecd956b00d5b"
    name                                       = "az-ch-hyp-m020-001"
    proxy_hypervisor_traffic_through_connector = false
    scopes                                     = []
    subscription_id                            = "18573a3d-bbfc-45f7-9912-cfa159ecd0f5"
    zone                                       = "b456e68d-c538-4e34-8c51-cc9c711e01a5"
}

# module.citrix_daas_hypervisor_azure.citrix_azure_hypervisor_resource_pool.resource_pool:
resource "citrix_azure_hypervisor_resource_pool" "resource_pool" {
    hypervisor                     = "5ff86c7a-4c3a-4c79-9f0d-ecd956b00d5b"
    id                             = "8f200091-ace5-44c1-8c6f-ae3c2502ff77"
    name                           = "vnet-020-ch-001"
    region                         = "Switzerland North"
    subnets                        = [
        "snet-m020-ch-001",
    ]
    virtual_network                = "vnet-m020-ch-001"
    virtual_network_resource_group = "rg-mvd-m020-ch-001"
    vm_tagging                     = true
}

# module.citrix_daas_hypervisor_azure.null_resource.wait_after_hypervisor:
resource "null_resource" "wait_after_hypervisor" {
    id = "1733911980825113254"
}


# module.citrix_delivery_group_hsd_test[0].citrix_delivery_group.hsd:
resource "citrix_delivery_group" "hsd" {
    associated_machine_catalogs = [
        {
            machine_catalog = "57d6aedd-b069-4c85-ac91-f492b9648132"
            machine_count   = 1
        },
    ]
    autoscale_settings          = {
        autoscale_enabled                                     = true
        disconnect_off_peak_idle_session_after_seconds        = 300
        disconnect_peak_idle_session_after_seconds            = 300
        log_off_off_peak_disconnected_session_after_seconds   = 60
        log_off_peak_disconnected_session_after_seconds       = 60
        log_off_reminder_enabled                              = false
        log_off_reminder_message                              = ""
        log_off_reminder_title                                = ""
        log_off_warning_message                               = ""
        log_off_warning_title                                 = ""
        off_peak_buffer_size_percent                          = 0
        off_peak_disconnect_action                            = "Nothing"
        off_peak_disconnect_timeout_minutes                   = 0
        off_peak_extended_disconnect_action                   = "Nothing"
        off_peak_extended_disconnect_timeout_minutes          = 0
        off_peak_limit_seconds_to_force_log_off_user          = 0
        off_peak_log_off_action                               = "Nothing"
        off_peak_log_off_reminder_interval                    = 0
        off_peak_log_off_timeout_minutes                      = 0
        peak_autoscale_assigned_power_on_idle_action          = "Nothing"
        peak_autoscale_assigned_power_on_idle_timeout_minutes = 0
        peak_buffer_size_percent                              = 0
        peak_disconnect_action                                = "Nothing"
        peak_disconnect_timeout_minutes                       = 0
        peak_extended_disconnect_action                       = "Nothing"
        peak_extended_disconnect_timeout_minutes              = 0
        peak_limit_seconds_to_force_log_off_user              = 0
        peak_log_off_action                                   = "Nothing"
        peak_log_off_reminder_interval                        = 0
        peak_log_off_timeout_minutes                          = 0
        power_off_delay_minutes                               = 0
        power_time_schemes                                    = [
            {
                days_of_week          = [
                    "Friday",
                    "Monday",
                    "Saturday",
                    "Sunday",
                    "Thursday",
                    "Tuesday",
                    "Wednesday",
                ]
                display_name          = "Development-Kostenoptimiert-24x7"
                peak_time_ranges      = []
                pool_using_percentage = false
            },
        ]
    }
    built_in_scopes             = [
        "00000000-0000-0000-0000-000000000000",
    ]
    color_depth                 = "TwentyFourBit"
    default_desktop_icon        = "-1"
    delivery_group_folder_path  = "M020"
    description                 = "Durch terraform für Kunden SIT-Mandant-m020 erstellt - HSD Desktop Publishing (Test)"
    desktops                    = [
        {
            description             = "KEYWORDS:Mandatory"
            enable_session_roaming  = false
            enabled                 = true
            id                      = "7c0110c0-fc5f-4faa-a85d-713f85f1696a"
            published_name          = "020-HSD-Desktop-Test"
            restricted_access_users = {
                allow_list = [
                    "m020\\GG_RG-NS-ICA",
                ]
                block_list = []
            }
        },
    ]
    enabled                     = true
    force_delete                = true
    id                          = "7f2d1553-918e-4a98-b785-3b5ebb936e54"
    in_maintenance_mode         = false
    inherited_scopes            = []
    load_balancing_type         = "Horizontal"
    minimum_functional_level    = "L7_34"
    name                        = "020-T-HSD-MCS-NON-ADJ-AZU-SIT-001"
    reboot_schedules            = [
        {
            description                  = "Nightly HSD Reboot"
            frequency                    = "Daily"
            frequency_factor             = 1
            ignore_maintenance_mode      = false
            name                         = "020-T-HSD-MCS-NON-ADJ-AZU-SIT-001-Reboot"
            natural_reboot_schedule      = false
            reboot_duration_minutes      = 30
            reboot_notification_to_users = {
                notification_duration_minutes       = 15
                notification_message                = "HSD Desktop will restart in 15 minutes"
                notification_repeat_every_5_minutes = true
                notification_title                  = "System Maintenance"
            }
            reboot_schedule_enabled      = true
            start_date                   = "2025-09-28"
            start_time                   = "22:00"
        },
    ]
    scopes                      = []
    secure_ica_required         = false
    session_support             = "MultiSession"
    sharing_kind                = "Shared"
    total_machines              = 1
}


# module.citrix_image_hsd.citrix_image_definition.hsd:
resource "citrix_image_definition" "hsd" {
    azure_image_definition   = {
        image_gallery_name = "gal_mvd_sta_ch_02"
        resource_group     = "rg-mvd-core-ch-001"
        use_image_gallery  = true
    }
    description              = "Windows Server 2022 HSD Multi Session Image für Mandant 020"
    hypervisor               = "5ff86c7a-4c3a-4c79-9f0d-ecd956b00d5b"
    hypervisor_resource_pool = "8f200091-ace5-44c1-8c6f-ae3c2502ff77"
    id                       = "9ffbb56d-f9fd-4b69-9807-9a26697ff047"
    latest_version           = 1
    name                     = "020-S-HSD-MCS-NON-ADJ-AZU-SIT-001"
    os_type                  = "Windows"
    session_support          = "MultiSession"
}

# module.citrix_image_hsd.citrix_image_version.hsd_multi["hsd_stable"]:
resource "citrix_image_version" "hsd_multi" {
    azure_image_specs        = {
        gallery_image    = {
            definition = "sta-svr-22-23h2-std-cor-spe-001"
            gallery    = "gal_mvd_sta_ch_02"
            version    = "2025.0922.0706"
        }
        machine_profile  = {
            machine_profile_resource_group = "rg-mvd-m020-ch-001"
            machine_profile_vm_name        = "mvd020050001"
        }
        resource_group   = "rg-mvd-core-ch-001"
        service_offering = "Standard_D2s_v3"
        storage_type     = "Premium_LRS"
    }
    description              = "Stable HSD version for production workloads"
    hypervisor               = "5ff86c7a-4c3a-4c79-9f0d-ecd956b00d5b"
    hypervisor_resource_pool = "8f200091-ace5-44c1-8c6f-ae3c2502ff77"
    id                       = "c7b73303-758f-4be5-aaf3-af953303149f"
    image_definition         = "9ffbb56d-f9fd-4b69-9807-9a26697ff047"
    os_type                  = "Windows"
    session_support          = "MultiSession"
    version_number           = 1
}


# module.citrix_machine_catalog_hsd_test[0].citrix_machine_catalog.hsd:
resource "citrix_machine_catalog" "hsd" {
    allocation_type             = "Random"
    built_in_scopes             = [
        "00000000-0000-0000-0000-000000000000",
    ]
    delete_machine_accounts     = "Delete"
    delete_virtual_machines     = true
    description                 = "Durch terraform für Kunden SIT-Mandant-m020 erstellt (Test Environment)"
    id                          = "57d6aedd-b069-4c85-ac91-f492b9648132"
    inherited_scopes            = []
    machine_catalog_folder_path = "M020"
    minimum_functional_level    = "L7_34"
    name                        = "020-T-HSD-MCS-NON-ADJ-AZU-SIT-001"
    persist_user_changes        = "Discard"
    provisioning_scheme         = {
        azure_machine_config           = {
            image_update_reboot_options = {
                reboot_duration         = 60
                warning_duration        = 10
                warning_message         = "🔄 System-Update 🔄 läuft! Neustart in ⏱️ %m% Minuten.  Speichere deine Arbeit! 💾 Claude ⏱ & Dima 😎 Support 😊"
                warning_repeat_interval = 5
            }
            machine_profile             = {
                machine_profile_resource_group = "rg-mvd-m020-ch-001"
                machine_profile_vm_name        = "mvd020050001"
            }
            master_image_note           = ""
            prepared_image              = {
                image_definition = "9ffbb56d-f9fd-4b69-9807-9a26697ff047"
                image_version    = "c7b73303-758f-4be5-aaf3-af953303149f"
            }
            service_offering            = "Standard_DC2ds_v3"
            storage_type                = "Azure_Ephemeral_OS_Disk"
            use_managed_disks           = true
            vda_resource_group          = "rg-mvd-m020-ch-001"
        }
        hypervisor                     = "5ff86c7a-4c3a-4c79-9f0d-ecd956b00d5b"
        hypervisor_resource_pool       = "8f200091-ace5-44c1-8c6f-ae3c2502ff77"
        identity_type                  = "ActiveDirectory"
        machine_account_creation_rules = {
            naming_scheme      = "mvd020051###"
            naming_scheme_type = "Numeric"
        }
        machine_domain_identity        = (sensitive value)
        number_of_total_machines       = 1
    }
    provisioning_type           = "MCS"
    scopes                      = []
    session_support             = "MultiSession"
    zone                        = "b456e68d-c538-4e34-8c51-cc9c711e01a5"
}


# module.citrix_protected_application[0].data.citrix_delivery_group.example_delivery_group:
data "citrix_delivery_group" "example_delivery_group" {
    color_depth                = "TwentyFourBit"
    delivery_group_folder_path = "M020"
    delivery_type              = "DesktopsAndApps"
    id                         = "7f2d1553-918e-4a98-b785-3b5ebb936e54"
    in_maintenance_mode        = false
    name                       = "020-T-HSD-MCS-NON-ADJ-AZU-SIT-001"
    secure_ica_required        = false
    vdas                       = [
        {
            associated_delivery_group  = "7f2d1553-918e-4a98-b785-3b5ebb936e54"
            associated_machine_catalog = "57d6aedd-b069-4c85-ac91-f492b9648132"
            hosted_machine_id          = "rg-mvd-m020-ch-001/mvd020051001"
            id                         = "fced59be-f3be-458e-8ea7-a2f6afbf4f45"
            machine_name               = "M020\\mvd020051001"
        },
    ]
}

# module.citrix_protected_application[0].citrix_application.published_application:
resource "citrix_application" "published_application" {
    application_category_path      = ""
    application_folder_path        = "M020"
    application_groups             = []
    browser_name                   = "Notepad"
    cpu_priority_level             = "Normal"
    delivery_groups                = [
        "7f2d1553-918e-4a98-b785-3b5ebb936e54",
    ]
    description                    = "Windows Application: Notepad"
    enabled                        = true
    home_zone_mode                 = "User"
    icon                           = "0"
    id                             = "bba64c93-d2b3-4332-81be-e4230504b93c"
    installed_app_properties       = {
        command_line_arguments  = "\"%**\""
        command_line_executable = "C:\\Windows\\System32\\notepad.exe"
        working_directory       = "%HOMEDRIVE%%HOMEPATH%"
    }
    limit_to_one_instance_per_user = false
    max_total_instances            = 0
    name                           = "Notepad"
    published_name                 = "Notepad"
    shortcut_added_to_desktop      = false
    shortcut_added_to_start_menu   = false
    visible                        = true
}


Outputs:

app_protection_help = {
    available_modes     = {
        none    = "Normal Terraform management (apps can be created, updated, destroyed)"
        strict  = "Apps cannot be destroyed or modified (prevent_destroy = true)"
        updates = "Apps can be destroyed but not modified (ignore_changes for critical attributes)"
    }
    change_mode         = "Use -var='app_protection_mode=none' for normal management"
    current_mode        = "none"
    override_protection = "Use -var='force_app_changes=true' to temporarily override protection"
}
app_protection_status = {
    app_created       = true
    app_name          = "Notepad"
    delivery_group    = "020-T-HSD-MCS-NON-ADJ-AZU-SIT-001"
    force_changes     = false
    managing_app      = true
    mode              = "none"
    protection_active = false
}
app_smart_defaults = {
    detected_app_name = "notepad"
    detected_filename = "notepad.exe"
    executable_path   = "C:\\Windows\\System32\\notepad.exe"
    smart_app_name    = "Notepad"
    smart_description = "Windows Application: Notepad"
    smart_published   = "Notepad"
}
